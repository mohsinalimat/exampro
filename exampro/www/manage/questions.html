{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ _('Manage Questions') }}
{% endblock %}

{% block page_content %}
<div class="container">
    <div class="row mb-5">
        <div class="col">
            <h4 class="text-center">❓ Manage Questions</h4>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-12 text-end">
            <div class="btn-toolbar justify-content-end">
                <button id="manage-categories-btn" class="btn btn-outline-secondary me-2">
                    <i class="fa fa-tags me-1"></i> Manage Categories
                </button>
                <button id="create-question-btn" class="btn btn-primary">
                    <i class="fa fa-plus-circle me-1"></i> Create Question
                </button>
            </div>
        </div>
    </div>
            
            <!-- Filter and Search -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <select id="category-filter" class="form-control">
                        <option value="all">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="type-filter" class="form-control">
                        <option value="all">All Types</option>
                        <option value="Choices">Choices</option>
                        <option value="User Input">User Input</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="question-search" class="form-control" placeholder="Search questions...">
                </div>
            </div>

            <!-- Questions Table -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Question Bank</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width: 40%">{{ _("Question") }}</th>
                                    <th>{{ _("Category") }}</th>
                                    <th>{{ _("Type") }}</th>
                                    <th>{{ _("Marks") }}</th>
                                    <th>{{ _("Actions") }}</th>
                                </tr>
                            </thead>
                            <tbody id="questions-table-body">
                                {% if not questions %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        {{ _("No questions found") }}
                                    </td>
                                </tr>
                                {% endif %}

                                {% for question in questions %}
                                <tr data-question="{{ question.name }}">
                                    <td>
                                        <div class="question-text">{{ question.question|truncate(80) }}</div>
                                    </td>
                                    <td>{{ question.category }}</td>
                                    <td>
                                        {% if question.type == "Choices" %}
                                            <span class="badge badge-info">Choices</span>
                                        {% elif question.type == "User Input" %}
                                            <span class="badge badge-secondary">User Input</span>
                                        {% else %}
                                            <span class="badge badge-dark">{{ question.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ question.mark }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-info view-question" data-question="{{ question.name }}">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                            <a href="/app/exam-question/{{ question.name }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-question" data-question="{{ question.name }}">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col">
                            <span id="question-count">Total Questions: {{ questions|length }}</span>
                        </div>
                        <div class="col">
                            <nav>
                                <ul class="pagination justify-content-end pagination-sm mb-0" id="pagination-container">
                                    <!-- Pagination will be inserted here by JS -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question Preview Modal -->
<div class="modal fade" id="questionPreviewModal" tabindex="-1" role="dialog" aria-labelledby="questionPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionPreviewModalLabel">Question Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="questionPreviewContent">
                <!-- Question preview will be loaded here -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Loading question preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Category Management Modal -->
<div class="modal fade" id="categoryManagementModal" tabindex="-1" role="dialog" aria-labelledby="categoryManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryManagementModalLabel">Manage Categories</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Add Category Form -->
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" id="new-category-name" class="form-control" placeholder="Enter a new category name">
                        <button type="button" id="add-category-btn" class="btn btn-primary">Add</button>
                    </div>
                    <div class="mt-2 text-muted small">Categories help organize your question bank.</div>
                </div>
                
                <!-- Categories List -->
                <div class="list-group" id="categories-list">
                    <div class="text-center my-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading categories...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Question Modal -->
<div class="modal fade" id="createQuestionModal" tabindex="-1" role="dialog" aria-labelledby="createQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createQuestionModalLabel">Create New Question</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-question-form">
                    <div class="row mb-3">
                        <!-- Question details -->
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="question-text" class="form-label">Question Text <span class="text-danger">*</span></label>
                                <textarea id="question-text" name="question" class="form-control" rows="4" required></textarea>
                                <div class="invalid-feedback">Please enter the question text.</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="question-category" class="form-label">Category <span class="text-danger">*</span></label>
                                        <select id="question-category" name="category" class="form-control" required>
                                            <option value="">Select a category</option>
                                            {% for category in categories %}
                                            <option value="{{ category.name }}">{{ category.title }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a category.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="question-type" class="form-label">Question Type <span class="text-danger">*</span></label>
                                        <select id="question-type" name="type" class="form-control" required>
                                            <option value="">Select a type</option>
                                            <option value="Choices">Choices</option>
                                            <option value="User Input">User Input</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a question type.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="question-marks" class="form-label">Marks</label>
                                        <input type="number" id="question-marks" name="mark" class="form-control" value="1" min="1" max="100">
                                        <div class="invalid-feedback">Please enter a valid mark value.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="description-image" class="form-label">Question Image</label>
                                        <input type="file" id="description-image" name="description_image" class="form-control" accept="image/*">
                                        <div class="invalid-feedback">Please select a valid image file.</div>
                                    </div>
                                </div>
                            </div>
                            <div id="description-image-preview" class="mb-3 d-none">
                                <img src="" alt="Question image preview" class="img-thumbnail" style="max-height: 150px;">
                                <button type="button" class="btn btn-sm btn-danger mt-1" id="remove-description-image">Remove Image</button>
                            </div>
                        </div>

                        <!-- Options section (will be shown/hidden based on question type) -->
                        <div class="col-md-6" id="options-container">
                            <div class="alert alert-info">
                                Please select a question type to configure answer options.
                            </div>
                            
                            <!-- Choices Options (initially hidden) -->
                            <div id="multiple-choice-options" class="d-none">
                                <h6 class="mb-3">Answer Options</h6>
                                
                                <!-- Option 1 -->
                                <div class="option-row mb-3 p-2 border rounded">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input correct-option" id="is-correct-1" name="is_correct_1" value="1">
                                            <label class="form-check-label" for="is-correct-1">Correct answer</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control option-text" id="option-1" name="option_1" rows="2" placeholder="Option 1"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="file" class="form-control option-image" id="option-1-image" name="option_1_image" accept="image/*">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="option-image-preview d-none">
                                                <img src="" class="img-thumbnail" style="height: 40px;">
                                                <button type="button" class="btn btn-sm btn-danger remove-option-image">×</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Option 2 -->
                                <div class="option-row mb-3 p-2 border rounded">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input correct-option" id="is-correct-2" name="is_correct_2" value="1">
                                            <label class="form-check-label" for="is-correct-2">Correct answer</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control option-text" id="option-2" name="option_2" rows="2" placeholder="Option 2"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="file" class="form-control option-image" id="option-2-image" name="option_2_image" accept="image/*">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="option-image-preview d-none">
                                                <img src="" class="img-thumbnail" style="height: 40px;">
                                                <button type="button" class="btn btn-sm btn-danger remove-option-image">×</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Option 3 -->
                                <div class="option-row mb-3 p-2 border rounded">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input correct-option" id="is-correct-3" name="is_correct_3" value="1">
                                            <label class="form-check-label" for="is-correct-3">Correct answer</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control option-text" id="option-3" name="option_3" rows="2" placeholder="Option 3 (optional)"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="file" class="form-control option-image" id="option-3-image" name="option_3_image" accept="image/*">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="option-image-preview d-none">
                                                <img src="" class="img-thumbnail" style="height: 40px;">
                                                <button type="button" class="btn btn-sm btn-danger remove-option-image">×</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Option 4 -->
                                <div class="option-row mb-3 p-2 border rounded">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input correct-option" id="is-correct-4" name="is_correct_4" value="1">
                                            <label class="form-check-label" for="is-correct-4">Correct answer</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <textarea class="form-control option-text" id="option-4" name="option_4" rows="2" placeholder="Option 4 (optional)"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="file" class="form-control option-image" id="option-4-image" name="option_4_image" accept="image/*">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="option-image-preview d-none">
                                                <img src="" class="img-thumbnail" style="height: 40px;">
                                                <button type="button" class="btn btn-sm btn-danger remove-option-image">×</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User Input Options (initially hidden) -->
                            <div id="text-question-options" class="d-none">
                                <h6 class="mb-3">Possible Correct Answers</h6>
                                <div class="form-group mb-3">
                                    <label for="possibility-1" class="form-label">Possible Answer 1 <span class="text-danger">*</span></label>
                                    <input type="text" id="possibility-1" name="possibility_1" class="form-control" placeholder="Required">
                                    <div class="form-text">Enter at least one possible correct answer</div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="possibility-2" class="form-label">Possible Answer 2</label>
                                    <input type="text" id="possibility-2" name="possibility_2" class="form-control" placeholder="Optional">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="possibility-3" class="form-label">Possible Answer 3</label>
                                    <input type="text" id="possibility-3" name="possibility_3" class="form-control" placeholder="Optional">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="possibility-4" class="form-label">Possible Answer 4</label>
                                    <input type="text" id="possibility-4" name="possibility_4" class="form-control" placeholder="Optional">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="create-question-error" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="save-question-btn" class="btn btn-primary">Save Question</button>
            </div>
        </div>
    </div>
</div>

<style>
.question-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 400px;
}
.badge {
    font-weight: 500;
    padding: 0.4em 0.8em;
}
.table td, .table th {
    padding: 0.75rem;
    vertical-align: middle;
}
/* Sidebar styles */
.sidebar {
    position: sticky;
    top: 0;
    height: calc(100vh - 60px);
    padding-top: 20px;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
}
.sidebar .nav-link {
    font-weight: 500;
    color: #333;
    padding: .75rem 1rem;
}
.sidebar .nav-link.active {
    color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}
.sidebar .nav-link:hover {
    color: #007bff;
}

/* Question preview styles */
.question-preview {
    padding: 1rem;
}
.option-item {
    border-radius: 4px;
    border: 1px solid #ddd;
    padding: 0.5rem !important;
}
.option-item.border-success {
    border-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}
</style>

<script>
frappe.ready(function() {
    // Pagination variables
    var currentPage = 1;
    var rowsPerPage = 50;
    var filteredQuestions = [];
    var allRows = $("#questions-table-body tr").not('[data-placeholder="true"]');
    // File upload variables
    var questionImageFile = null;
    var optionImageFiles = {
        option_1_image: null,
        option_2_image: null,
        option_3_image: null,
        option_4_image: null
    };
    
    // Initialize pagination
    function initPagination() {
        // Get filtered questions
        applyFilters();
        
        // Calculate the number of pages
        var numPages = Math.ceil(filteredQuestions.length / rowsPerPage);
        
        // Create pagination controls
        updatePagination(numPages);
        
        // Display the first page
        displayPage(1);
    }
    
    // Apply filters to the table
    function applyFilters() {
        var searchTerm = $("#question-search").val().toLowerCase();
        var categoryFilter = $("#category-filter").val();
        var typeFilter = $("#type-filter").val();
        
        // Reset filtered questions
        filteredQuestions = [];
        
        // Apply filters
        allRows.each(function() {
            var $row = $(this);
            var questionText = $row.find('td:eq(0)').text().toLowerCase();
            var category = $row.find('td:eq(1)').text();
            var type = '';
            
            if ($row.find('.badge-info').length > 0) type = "Choices";
            else if ($row.find('.badge-secondary').length > 0) type = "User Input";
            else type = $row.find('td:eq(2)').text();
            
            var matchesSearch = !searchTerm || questionText.indexOf(searchTerm) > -1;
            var matchesCategory = categoryFilter === 'all' || category === categoryFilter;
            var matchesType = typeFilter === 'all' || type === typeFilter;
            
            if (matchesSearch && matchesCategory && matchesType) {
                filteredQuestions.push($row);
            }
        });
        
        // Update question count
        $("#question-count").text(`Total Questions: ${filteredQuestions.length} of ${allRows.length}`);
    }
    
    // Update pagination controls
    function updatePagination(numPages) {
        var $pagination = $("#pagination-container");
        $pagination.empty();
        
        // Don't show pagination if only one page
        if (numPages <= 1) {
            return;
        }
        
        // Previous button
        $pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="prev">&laquo;</a>
            </li>
        `);
        
        // Page numbers
        var startPage = Math.max(1, currentPage - 2);
        var endPage = Math.min(numPages, startPage + 4);
        
        for (var i = startPage; i <= endPage; i++) {
            $pagination.append(`
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `);
        }
        
        // Next button
        $pagination.append(`
            <li class="page-item ${currentPage === numPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="next">&raquo;</a>
            </li>
        `);
        
        // Handle pagination clicks
        $(".page-link").on("click", function(e) {
            e.preventDefault();
            
            var page = $(this).data('page');
            if (page === 'prev') {
                if (currentPage > 1) {
                    displayPage(currentPage - 1);
                }
            } else if (page === 'next') {
                var numPages = Math.ceil(filteredQuestions.length / rowsPerPage);
                if (currentPage < numPages) {
                    displayPage(currentPage + 1);
                }
            } else {
                displayPage(page);
            }
        });
    }
    
    // Display a specific page
    function displayPage(page) {
        currentPage = page;
        
        // Calculate indexes
        var startIndex = (page - 1) * rowsPerPage;
        var endIndex = Math.min(startIndex + rowsPerPage, filteredQuestions.length);
        
        // Hide all rows
        allRows.hide();
        
        // Show only the rows for the current page
        for (var i = startIndex; i < endIndex; i++) {
            $(filteredQuestions[i]).show();
        }
        
        // Update pagination controls
        var numPages = Math.ceil(filteredQuestions.length / rowsPerPage);
        updatePagination(numPages);
        
        // Show no results message if needed
        if (filteredQuestions.length === 0) {
            var colSpan = $("#questions-table-body tr:first td").length || 5;
            
            // Remove any existing placeholder row
            $("#questions-table-body tr[data-placeholder='true']").remove();
            
            // Add placeholder row
            $("#questions-table-body").append(`
                <tr data-placeholder="true">
                    <td colspan="${colSpan}" class="text-center py-4">
                        No questions match the current filters
                    </td>
                </tr>
            `);
        } else {
            // Remove placeholder if it exists
            $("#questions-table-body tr[data-placeholder='true']").remove();
        }
    }
    
    // Handle question search
    $("#question-search").on("keyup", function() {
        currentPage = 1;
        initPagination();
    });
    
    // Handle category filter
    $("#category-filter").on("change", function() {
        currentPage = 1;
        initPagination();
    });
    
    // Handle type filter
    $("#type-filter").on("change", function() {
        currentPage = 1;
        initPagination();
    });
    
    // Handle create question button
    $("#create-question-btn").on("click", function() {
        $('#createQuestionModal').modal('show');
    });
    
    // Handle manage categories button
    $("#manage-categories-btn").on("click", function() {
        loadCategories();
        $('#categoryManagementModal').modal('show');
    });
    
    // Handle view question (preview)
    $(document).on("click", ".view-question", function() {
        var questionName = $(this).data('question');
        
        // Show modal with loading spinner
        $('#questionPreviewModal').modal('show');
        
        // Load question preview
        frappe.call({
            method: 'exampro.www.manage.questions.get_question_preview',
            args: {
                question: questionName
            },
            callback: function(response) {
                if (response.message && response.message.success) {
                    // Update modal content
                    $('#questionPreviewContent').html(response.message.html);
                } else {
                    // Show error
                    $('#questionPreviewContent').html(`
                        <div class="alert alert-danger">
                            Failed to load question preview: ${response.message.error || 'Unknown error'}
                        </div>
                    `);
                }
            }
        });
    });
    
    // Handle duplicate question
    $(document).on("click", ".duplicate-question", function() {
        var questionName = $(this).data('question');
        
        frappe.call({
            method: 'exampro.www.manage.questions.duplicate_question',
            args: {
                question: questionName
            },
            callback: function(response) {
                if (response.message && response.message.success) {
                    frappe.show_alert({
                        message: 'Question duplicated successfully',
                        indicator: 'green'
                    }, 3);
                    
                    // Refresh the page
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    frappe.show_alert({
                        message: response.message.error || 'Failed to duplicate question',
                        indicator: 'red'
                    }, 5);
                }
            }
        });
    });
    
    // Handle delete question
    $(document).on("click", ".delete-question", function() {
        var questionName = $(this).data('question');
        
        frappe.confirm('Are you sure you want to delete this question? This action cannot be undone.',
            function() {
                frappe.call({
                    method: 'exampro.www.manage.questions.delete_question',
                    args: {
                        question: questionName
                    },
                    callback: function(response) {
                        if (response.message && response.message.success) {
                            frappe.show_alert({
                                message: 'Question deleted successfully',
                                indicator: 'green'
                            }, 3);
                            
                            // Remove the row and refresh pagination
                            $(`tr[data-question="${questionName}"]`).remove();
                            allRows = $("#questions-table-body tr").not('[data-placeholder="true"]');
                            initPagination();
                        } else {
                            frappe.show_alert({
                                message: response.message.error || 'Failed to delete question',
                                indicator: 'red'
                            }, 5);
                        }
                    }
                });
            }
        );
    });
    
    // Modal cleanup on close
    $('#questionPreviewModal').on('hidden.bs.modal', function () {
        $('#questionPreviewContent').html(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2">Loading question preview...</p>
            </div>
        `);
    });
    
    // Initialize pagination on page load
    initPagination();
    
    // ---- Category Management Functions ----
    
    // Load categories into the management modal
    function loadCategories() {
        $("#categories-list").html(`
            <div class="text-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading categories...</span>
                </div>
            </div>
        `);
        
        frappe.call({
            method: 'exampro.www.manage.questions.get_all_categories',
            callback: function(response) {
                if (response.message && response.message.success) {
                    renderCategoriesList(response.message.categories);
                } else {
                    let errorMsg = response.message && response.message.error ? response.message.error : 'Failed to load categories';
                    $("#categories-list").html(`
                        <div class="alert alert-info">No categories found. Create your first category above.</div>
                    `);
                }
            }
        });
    }
    
    // Render the categories list
    function renderCategoriesList(categories) {
        if (!categories.length) {
            $("#categories-list").html(`
                <div class="alert alert-info">No categories found. Create your first category above.</div>
            `);
            return;
        }
        
        let html = '';
        categories.forEach(function(category) {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    ${category.title}
                    <button type="button" class="btn btn-sm btn-danger delete-category" data-category="${category.name}">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
        });
        
        $("#categories-list").html(html);
        
        // Handle delete category button
        $(".delete-category").on("click", function() {
            const categoryName = $(this).data('category');
            deleteCategory(categoryName);
        });
    }
    
    // Add new category
    $("#add-category-btn").on("click", function() {
        const title = $("#new-category-name").val().trim();
        
        if (!title) {
            frappe.show_alert({
                message: 'Please enter a category name',
                indicator: 'red'
            }, 3);
            return;
        }
        
        frappe.call({
            method: 'exampro.www.manage.questions.add_question_category',
            args: {
                title: title
            },
            callback: function(response) {
                if (response.message && response.message.success) {
                    frappe.show_alert({
                        message: 'Category added successfully',
                        indicator: 'green'
                    }, 3);
                    
                    // Clear the input
                    $("#new-category-name").val('');
                    
                    // Reload categories
                    loadCategories();
                    
                    // Update category dropdowns
                    updateCategoryDropdowns();
                } else {
                    frappe.show_alert({
                        message: response.message.error || 'Failed to add category',
                        indicator: 'red'
                    }, 5);
                }
            }
        });
    });
    
    // Delete category
    function deleteCategory(categoryName) {
        frappe.confirm('Are you sure you want to delete this category? This action cannot be undone.',
            function() {
                frappe.call({
                    method: 'exampro.www.manage.questions.delete_question_category',
                    args: {
                        category_name: categoryName
                    },
                    callback: function(response) {
                        if (response.message && response.message.success) {
                            frappe.show_alert({
                                message: 'Category deleted successfully',
                                indicator: 'green'
                            }, 3);
                            
                            // Reload categories
                            loadCategories();
                            
                            // Update category dropdowns
                            updateCategoryDropdowns();
                        } else {
                            let errorMsg = response.message.error || 'Failed to delete category';
                            if (response.message.question_count) {
                                errorMsg += ` (${response.message.question_count} questions are using this category)`;
                            }
                            
                            frappe.show_alert({
                                message: errorMsg,
                                indicator: 'red'
                            }, 5);
                        }
                    }
                });
            }
        );
    }
    
    // Update category dropdowns after adding/deleting categories
    function updateCategoryDropdowns() {
        frappe.call({
            method: 'exampro.www.manage.questions.get_all_categories',
            callback: function(response) {
                if (response.message && response.message.success) {
                    let categories = response.message.categories;
                    
                    // Update filter dropdown
                    let filterDropdown = $('#category-filter');
                    let selectedCategory = filterDropdown.val();
                    filterDropdown.empty();
                    filterDropdown.append(`<option value="all">All Categories</option>`);
                    
                    // Update create question dropdown
                    let createDropdown = $('#question-category');
                    let selectedCreateCategory = createDropdown.val();
                    createDropdown.empty();
                    createDropdown.append(`<option value="">Select a category</option>`);
                    
                    categories.forEach(function(category) {
                        filterDropdown.append(`<option value="${category.name}">${category.title}</option>`);
                        createDropdown.append(`<option value="${category.name}">${category.title}</option>`);
                    });
                    
                    // Restore selection if possible
                    if (selectedCategory && filterDropdown.find(`option[value="${selectedCategory}"]`).length) {
                        filterDropdown.val(selectedCategory);
                    }
                    
                    if (selectedCreateCategory && createDropdown.find(`option[value="${selectedCreateCategory}"]`).length) {
                        createDropdown.val(selectedCreateCategory);
                    }
                }
            }
        });
    }
    
    // ---- Create Question Modal Functions ----
    
    // Handle question type change
    $("#question-type").on("change", function() {
        const questionType = $(this).val();
        
        // Hide all option containers
        $("#multiple-choice-options, #text-question-options").addClass("d-none");
        
        // Show the relevant container based on question type
        if (questionType === "Choices") {
            $("#multiple-choice-options").removeClass("d-none");
            
            // For Choices questions, allow multiple correct answers
            $(".correct-option").prop("type", "checkbox").each(function(i) {
                $(this).prop("name", "is_correct_" + (i+1));
            });
        } else if (questionType === "User Input") {
            $("#text-question-options").removeClass("d-none");
        }
    });
    
    // Handle file uploads for question image
    $("#description-image").on("change", function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $("#description-image-preview img").attr("src", e.target.result);
                $("#description-image-preview").removeClass("d-none");
                questionImageFile = file;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Handle remove question image button
    $("#remove-description-image").on("click", function() {
        $("#description-image").val("");
        $("#description-image-preview").addClass("d-none");
        questionImageFile = null;
    });
    
    // Handle file uploads for option images
    $(".option-image").on("change", function() {
        const file = this.files[0];
        if (file) {
            const $preview = $(this).closest(".row").find(".option-image-preview");
            const reader = new FileReader();
            const fieldName = $(this).attr("name");
            
            reader.onload = function(e) {
                $preview.find("img").attr("src", e.target.result);
                $preview.removeClass("d-none");
                optionImageFiles[fieldName] = file;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Handle remove option image buttons
    $(document).on("click", ".remove-option-image", function() {
        const $container = $(this).closest(".row");
        const $fileInput = $container.find(".option-image");
        const fieldName = $fileInput.attr("name");
        
        $fileInput.val("");
        $container.find(".option-image-preview").addClass("d-none");
        optionImageFiles[fieldName] = null;
    });
    
    // Reset the create question form
    function resetCreateQuestionForm() {
        $("#create-question-form")[0].reset();
        $("#multiple-choice-options, #text-question-options").addClass("d-none");
        $("#description-image-preview").addClass("d-none");
        $(".option-image-preview").addClass("d-none");
        $("#create-question-error").addClass("d-none");
        
        // Reset file variables
        questionImageFile = null;
        optionImageFiles = {
            option_1_image: null,
            option_2_image: null,
            option_3_image: null,
            option_4_image: null
        };
    }
    
    // Handle create question form submission
    $("#save-question-btn").on("click", function() {
        // Validate form
        const form = $("#create-question-form")[0];
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Get form data
        const formData = {
            question: $("#question-text").val(),
            category: $("#question-category").val(),
            type: $("#question-type").val(),
            mark: $("#question-marks").val()
        };
        
        // Validate required fields
        if (!formData.question || !formData.category || !formData.type) {
            $("#create-question-error")
                .text("Please fill in all required fields")
                .removeClass("d-none");
            return;
        }
        
        // For Choices questions, validate options
        if (formData.type === "Choices") {
            // Check if at least 2 options are provided
            let optionsCount = 0;
            let correctCount = 0;
            
            for (let i = 1; i <= 4; i++) {
                const optionText = $(`#option-${i}`).val().trim();
                if (optionText) {
                    optionsCount++;
                    formData[`option_${i}`] = optionText;
                    
                    if ($(`#is-correct-${i}`).prop("checked")) {
                        correctCount++;
                        formData[`is_correct_${i}`] = 1;
                    } else {
                        formData[`is_correct_${i}`] = 0;
                    }
                }
            }
            
            if (optionsCount < 2) {
                $("#create-question-error")
                    .text("Please provide at least two options")
                    .removeClass("d-none");
                return;
            }
            
            if (correctCount === 0) {
                $("#create-question-error")
                    .text("Please select at least one correct answer")
                    .removeClass("d-none");
                return;
            }
        }
        
        // For User Input questions, validate possible answers
        if (formData.type === "User Input") {
            const possibility1 = $("#possibility-1").val().trim();
            if (!possibility1) {
                $("#create-question-error")
                    .text("Please provide at least one possible answer")
                    .removeClass("d-none");
                return;
            }
            
            formData.possibility_1 = possibility1;
            
            for (let i = 2; i <= 4; i++) {
                const possibility = $(`#possibility-${i}`).val().trim();
                if (possibility) {
                    formData[`possibility_${i}`] = possibility;
                }
            }
        }
        
        // Show loading state
        $("#save-question-btn").prop("disabled", true).html(
            `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`
        );
        
        // Upload files first (if any)
        uploadFiles(formData).then(function(updatedFormData) {
            // Create the question
            frappe.call({
                method: 'exampro.www.manage.questions.create_question',
                args: {
                    question_data: updatedFormData
                },
                callback: function(response) {
                    // Reset button state
                    $("#save-question-btn").prop("disabled", false).text("Save Question");
                    
                    if (response.message && response.message.success) {
                        frappe.show_alert({
                            message: 'Question created successfully',
                            indicator: 'green'
                        }, 3);
                        
                        // Close modal and reset form
                        $('#createQuestionModal').modal('hide');
                        resetCreateQuestionForm();
                        
                        // Refresh the page to show the new question
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        $("#create-question-error")
                            .text(response.message.error || "Failed to create question")
                            .removeClass("d-none");
                    }
                }
            });
        });
    });
    
    // Handle modal cleanup
    $('#createQuestionModal').on('hidden.bs.modal', function () {
        resetCreateQuestionForm();
    });
    
    // Upload files and update form data with file URLs
    async function uploadFiles(formData) {
        // Create a copy of the form data
        const updatedFormData = { ...formData };
        
        // Upload question image if exists
        if (questionImageFile) {
            try {
                const questionImageUrl = await uploadFile(questionImageFile);
                updatedFormData.description_image = questionImageUrl;
            } catch (error) {
                console.error("Error uploading question image:", error);
            }
        }
        
        // Upload option images if exist
        for (const field in optionImageFiles) {
            const file = optionImageFiles[field];
            if (file) {
                try {
                    const imageUrl = await uploadFile(file);
                    updatedFormData[field] = imageUrl;
                } catch (error) {
                    console.error(`Error uploading ${field}:`, error);
                }
            }
        }
        
        return updatedFormData;
    }
    
    // Upload a single file and return the URL
    function uploadFile(file) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const formData = new FormData();
            
            formData.append('file', file, file.name);
            formData.append('is_private', 0);
            formData.append('doctype', 'Exam Question');
            formData.append('fieldname', 'image');
            
            xhr.open('POST', '/api/method/upload_file', true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.setRequestHeader('X-Frappe-CSRF-Token', frappe.csrf_token);
            
            xhr.onload = function() {
                if (this.status >= 200 && this.status < 300) {
                    const response = JSON.parse(this.responseText);
                    if (response.message && response.message.file_url) {
                        resolve(response.message.file_url);
                    } else {
                        reject({
                            status: this.status,
                            statusText: "File URL not found in response"
                        });
                    }
                } else {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                }
            };
            
            xhr.onerror = function() {
                reject({
                    status: this.status,
                    statusText: xhr.statusText
                });
            };
            
            xhr.send(formData);
        });
    }
});
</script>
{% endblock %}
